@page "/weather/daily"
@inject HttpClient Http
@rendermode InteractiveServer
@using Blazorise.Charts
@using Blazorise.DataGrid
@using Blazorise.Components
@using Instrukcja.Model

<h1>Daily Weather Forecast</h1>

@if (weatherData != null && weatherData.Daily.Any()) //TU SIĘ DZIEJE MNIEJ WIĘCEJ TO SAMO CO W Weather.razor
{
    <Card>
        <CardBody>
            <BarChart TItem="double" TLabel="string" @ref="barChart"/>
        </CardBody>
    </Card>
    <Divider/>
}
else
{
    <p>Loading daily weather data chart...</p>
}

<h1>Temperature Daily Data</h1>

@if (dailyTempData != null && dailyTempData.Any())
{
    <Card>
        <CardBody>
            <DataGrid TItem="Temperature" Data="@dailyTempData">
                <DataGridColumn Field="@nameof(Temperature.Date)" Caption="Date"/>
                <DataGridColumn Field="@nameof(Temperature.Day)" Caption="Day Temperature [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Day)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(Temperature.Min)" Caption="Min. Temperature [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Min)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(Temperature.Max)" Caption="Max. Temperature [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Max)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(Temperature.Morn)" Caption="Morning Temperature [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Morn)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(Temperature.Eve)" Caption="Evening Temperature [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Eve)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(Temperature.Night)" Caption="Night Temperature [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Night)
                    </DisplayTemplate>
                </DataGridColumn>
            </DataGrid>
        </CardBody>
    </Card>
    <Divider />
} else
{
    <p>Loading daily temperature data table...</p>
}

<h1>Complex Daily Weather Data</h1>
@if (dailyWeatherData != null && dailyWeatherData.Any())
{
    <Card>
        <CardBody>
            <DataGrid TItem="WeatherDaily" Data="@dailyWeatherData">
                <DataGridColumn Field="@nameof(WeatherDaily.Dt)" Caption="Date">
                    <DisplayTemplate>
                        @FormatDate(context.Dt)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(WeatherDaily.Pressure)" Caption="Pressure [hPa]" />
                <DataGridColumn Field="@nameof(WeatherDaily.Humidity)" Caption="Humidity [%]" />
                <DataGridColumn Field="@nameof(WeatherDaily.Dew_point)" Caption="Dew Point [°C]">
                    <DisplayTemplate>
                        @FormatTemperature(context.Dew_point)
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn Field="@nameof(WeatherDaily.Wind_speed)" Caption="Wind Speed [m/s]" />
                <DataGridColumn Field="@nameof(WeatherDaily.Clouds)" Caption="Clouds [%]" />
                <DataGridColumn Field="@nameof(WeatherDaily.Uvi)" Caption="UV Index" />
                <DataGridColumn Field="@nameof(WeatherDaily.Pop)" Caption="Probability of Precipitation [%]">
                    <DisplayTemplate>
                        @FormatPop(context.Pop)
                    </DisplayTemplate>
                </DataGridColumn>
            </DataGrid>
        </CardBody>
    </Card>
}
else
{
    <p>Loading daily weather complex data table...</p>
}

@code {
    public WeatherResponse weatherData;
    public List<Temperature> dailyTempData = new();
    public List<WeatherDaily> dailyWeatherData = new();

    private BarChart<double> barChart = new();
    private List<double> actualTemperatures = new();
    private List<double> feelsLikeTemperatures = new();
    private List<string> dateLabels = new();

    // Kolorki do wykresów, bez list nie chce poprawnie działać
    List<string> backgroundColors = new List<string> {
        ChartColor.FromRgba(255, 99, 132, 0.2f)};
    List<string> backgroundColors2 = new List<string> {
        ChartColor.FromRgba(54, 162, 235, 0.2f)};
    List<string> borderColors = new List<string> {
        ChartColor.FromRgba(255, 99, 132, 1f)};
    List<string> borderColors2 = new List<string> {
        ChartColor.FromRgba(54, 162, 235, 1f)};

    protected override async Task OnInitializedAsync()
    {
        await LoadDailyWeather(false);
        Console.WriteLine("Data loaded successfully to the program");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadDailyWeather(firstRender);
            await HandleRedraw();
        }
    }

    async Task HandleRedraw()
    {
        if (barChart != null)
        {
            await barChart.Clear();

            await barChart.AddLabelsDatasetsAndUpdate(dateLabels, GetBarChartDataset(), GetBarChartDataset2());
        }
    }

    private async Task LoadDailyWeather(bool firstRender)
    {
        try
        {
            var url = "https://api.openweathermap.org/data/3.0/onecall?lat=52.2297&lon=21.0122&appid=84c28f5c4cc0e8e22f5c365f20443e98&exclude=minutely,hourly,current,alerts";
            weatherData = await Http.GetFromJsonAsync<WeatherResponse>(url);

            // Czyszczenie list, aby nie powstały nadmierne dane
            actualTemperatures.Clear();
            feelsLikeTemperatures.Clear();
            dateLabels.Clear();
            dailyTempData.Clear();
            dailyWeatherData.Clear();

            int i = 0;

            // Ładowanie danych do list
            foreach (var day in weatherData.Daily)
            {
                actualTemperatures.Add(day.Temp.Day - 273.15); // Konwersja z Kelwinów na Celsjusze
                feelsLikeTemperatures.Add(day.Feels_like.Day - 273.15); // Konwersja z Kelwinów na Celsjusze
                dateLabels.Add(FormatDate(day.Dt)); // Dodawanie dat do jako etykiet wykresu
                dailyTempData.Add(day.Temp); // Dodawanie temperatur do tabeli
                dailyWeatherData.Add(day);
                day.Temp.Date = dateLabels[i]; // Uzupelnianie informacji o datach przy temperaturach (potrzebne do tabeli)
                i++;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
    }

    // Zestaw danych temperatury faktycznej do wykresu
    BarChartDataset<double> GetBarChartDataset()
    {
        return new BarChartDataset<double>
            {
                Label = "Actual Temperature [°C]",
                Data = actualTemperatures,
                BackgroundColor = backgroundColors,
                BorderColor = borderColors
            };
    }
    // Zestaw danych temperatury odczuwalnej do wykresu
    BarChartDataset<double> GetBarChartDataset2()
    {
        return new BarChartDataset<double>
            {
                Label = "Feels-Like Temperature [°C]",
                Data = feelsLikeTemperatures,
                BackgroundColor = backgroundColors2,
                BorderColor = borderColors2
            };
    }

    private string FormatTemperature(double kelvin)
    {
        return (kelvin - 273.15).ToString("N2");
    }

    private string FormatDate(long unixDateTime)
    {
        DateTimeOffset dateTimeOffset = DateTimeOffset.FromUnixTimeSeconds(unixDateTime);
        return dateTimeOffset.LocalDateTime.ToString("g"); 
    }

    private string FormatPop(double pop)
    {
        return (pop * 100).ToString();
    }
}
